---
title: "Simulating multiple populations at once"
author: "Jaideep Joshi"
date: "28 March 2022"
output: html_document
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F, echo = F}
library(rfish)
library(tidyverse)
source("../tests/ref/parameters.cod.R")
source("../tests/ref/simulator.7.R")
```

We can use the fishery simulator to simulate multiple populations (i.e., populations with different control parameters) at once. Suppose we want to look at fishery properties as a function of the harvest proportion. 

### Preparation

As usual, we begin with creating a prototype fish 

```{r}
# Create a prototype fish as usual
fish = new(Fish)
# fish$par$s0 = 0.09637

sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(1.93e3, 5.61)
```


### Create a population to simulate

```{r}
pop = new(Population, fish)
# pop$par$Bhalf = 365426284/4.7
# pop$set_superFishSize(5e6)
pop$verbose = F
```

This population will be reused by the simulator.

### Simulate

We can now simulate populations with different harvesting rates. Here, we simulate 20 populations with harvesting rates specified by the `hvec` vector. The `simulate_multi` function returns an array if dimensions `{nsteps, length(hvec), 4}`. The last dimension is four because four utilities are returned: {ssb, yield, employment, profit}.

```{r}
nsteps = 200
hvec = seq(0, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)

res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T)
```

### Plot

```{r}
plot_hscan = function(res_ibm_full){
  lf = 45
  arr = res_ibm_full 
  dat_ibm = data.frame(matrix(ncol=6, nrow=0))
  colnames(dat_ibm) = c("ssb", "yield", "emp.sea", "emp.shr", "profit.sea", "profit.shr")
  dat = data.frame(matrix(ncol=6, nrow=0))
  colnames(dat) = c("ssb", "yield", "emp.sea", "emp.shr", "profit.sea", "profit.shr")
  for (ih in 1:length(hvec)){
    res = simulate(hvec[ih], lf, F)
    v = colMeans((res$summaries %>% select(SSB, Y, D.sea, D.shr, P.sea, P.shr))[151:200,])
    dat[nrow(dat)+1,] = v/c(1e9, 1e9, 1, 1, 1e9, 1e9)
    v_ibm = colMeans(arr[151:200, ih, 1,])
    dat_ibm[nrow(dat_ibm)+1,] = v_ibm/c(1e9, 1e9, 1, 1, 1e9, 1e9)
  }
  # dat$employment = dat$emp.sea+dat$emp.shr
  # dat$profit = dat$profit.sea+dat$profit.shr
  
  
  par(mfrow = c(3,2), mar=c(5,5,1,1), cex.lab=1.5, cex.axis=1.5)
  matplot(ylab="ssb (MT)",y=cbind(dat_ibm$ssb, dat$ssb, dat_ibm$tsb, dat$tsb), x=hvec, type="l", col=c("cyan2", "black", "orange", "magenta"), lwd=2:1, lty=1, xlab="Harvest prop")
  matplot(ylab="yield (MT)",y=cbind(dat_ibm$yield, dat$yield), x=hvec, type="l", col=c("cyan2", "black"), lwd=2:1, lty=1, xlab="Harvest prop")
  matplot(ylab="employment sea (PY)",y=cbind(dat_ibm$emp.sea, dat$emp.sea), x=hvec, type="l", col=c("cyan2", "black"), lwd=2:1, lty=1, xlab="Harvest prop")
  matplot(ylab="employment shore (PY)",y=cbind(dat_ibm$emp.shr, dat$emp.shr), x=hvec, type="l", col=c("cyan2", "black"), lwd=2:1, lty=1, xlab="Harvest prop")
  matplot(ylab="profit sea (Bn NOK)",y=cbind(dat_ibm$profit.sea, dat$profit.sea), x=hvec, type="l", col=c("cyan2", "black"), lwd=2:1, lty=1, xlab="Harvest prop")
  matplot(ylab="profit shore (Bn NOK)",y=cbind(dat_ibm$profit.shr, dat$profit.shr), x=hvec, type="l", col=c("cyan2", "black"), lwd=2:1, lty=1, xlab="Harvest prop")
}

plot_hscan(res_ibm_full)
```

### Simulate with old mortality model

```{r}
fish = new(Fish)
fish$par$use_old_model_mor = T

sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(1.93e3, 5.61)

pop = new(Population, fish)
pop$verbose = F

nsteps = 200
hvec = seq(0, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)

res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T)

plot_hscan(res_ibm_full)
```

### Simulate with fully old model (new effort dynamics)

```{r}
fish = new(Fish)
fish$par$growth_model = 0
fish$par$use_old_model_mor = T
fish$par$use_old_model_mat = T
fish$par$use_old_model_fec = T
fish$par$s0 = 0.0937

sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(1.93e3, 5.61)

pop = new(Population, fish)
pop$par$Bhalf = 3.65e8
pop$par$dsea = 0.054 # (original value)
pop$set_superFishSize(2e6)
pop$verbose = F

nsteps = 200
hvec = seq(0, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)

res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T)

plot_hscan(res_ibm_full)
```

### Simulate with fully old model (new effort dynamics, tuned dsea)

Notice that with the new effort dynamics model, employment is slightly underpredicted. Therefore, it is necessary to recalibrate the parameter `dsea` as here. 

Besides, since there is a condition that there is at least 1 superfish in the population at all times to prevent a complete population collapse, calculating average mortality over the fishable population as $M=\sum{w_i m_i}/\sum{w_i}$ with $i$ running over all age classes results in a finite (or even increasing) employment at sea at high harvest proportions. To solve this problem, I exclude $i=1$ in the expression for $M$. 

```{r}
fish = new(Fish)
fish$par$growth_model = 0
fish$par$use_old_model_mor = T
fish$par$use_old_model_mat = T
fish$par$use_old_model_fec = T
fish$par$s0 = 0.0937

sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(1.93e3, 5.61)

pop = new(Population, fish)
pop$par$Bhalf = 3.65e8
pop$par$dsea = 0.09 # tuned value
pop$set_superFishSize(2e6)
pop$verbose = F

nsteps = 200
hvec = seq(0, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)

res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T)

plot_hscan(res_ibm_full)
```

### Simulate with old growth model, rest new

```{r}
fish = new(Fish)
fish$par$growth_model = 0
fish$par$use_old_model_mor = F
fish$par$use_old_model_mat = F
fish$par$use_old_model_fec = F
fish$par$s0 = 0.09637

sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(1.93e3, 5.61)

pop = new(Population, fish)
pop$par$Bhalf = 3.65e8
pop$par$dsea = 0.09 # tuned value
pop$set_superFishSize(2e6)
pop$verbose = F

nsteps = 200
hvec = seq(0, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)

res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T)

plot_hscan(res_ibm_full)
```
