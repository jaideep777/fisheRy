---
title: "Simulating a fished population"
author: "Jaideep Joshi"
date: "28 March 2022"
output: html_document
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F, echo = F}
library(rfish)
library(tidyverse)
source("../tests/ref/parameters.cod.R")
source("../tests/ref/simulator.7.R")
```

```{r}
dat = read.csv("~/Documents/fish_project/growth_model_calib_data/environmental.csv")
dat=dat[17:91,]
```

```{r}
plot_timeseries = function(res_ibm, pop, h){
  res = simulate(h, lf, F)
  
  d = pop$get_state()
  table(d$age)
  par(mfrow = c(2,3), mar=c(4,4,1,1))
  
  nyears = nrow(res_ibm)
  dat_t = (nyears-nrow(dat)+1) : nyears
    
  ssb.max = max(c(res_ibm$ssb/1e9, res$summaries$SSB/1e9, dat$ssb*1e3/1e9), na.rm = T)
  plot(y=res_ibm$ssb/1e9, x=seq(1,nsteps,1), ylab="SSB (MT)", xlab="Year", col="cyan3", type="l", ylim=c(0,ssb.max))
  points(y=res$summaries$SSB/1e9, x=res$summaries$year, type="l")
  points(y=dat$ssb*1e3/1e9, x=dat_t, col="green", type="o", lwd=0.4)

  tsb.max = max(c(res_ibm$tsb/1e9, res$summaries$TSB/1e9, dat$totb*1e3/1e9), na.rm=T)
  plot(y=res_ibm$tsb/1e9, x=seq(1,nsteps,1), ylab="TSB (MT)", xlab="Year", col="cyan3", type="l", ylim=c(0,tsb.max))
  points(y=res$summaries$TSB/1e9, x=res$summaries$year, type="l")
  points(y=dat$totb*1e3/1e9, x=dat_t, col="green", type="o", lwd=0.4)

  yield.max = max(c(res_ibm$yield/1e9, res$summaries$Y/1e9))
  plot(y=res_ibm$yield/1e9, x=seq(1,nsteps,1), ylab="Yield (MT)", xlab="Year", col="cyan3", type="l", ylim=c(0,yield.max))
  points(y=res$summaries$Y/1e9, x=res$summaries$year, type="l")
  points(y=dat$catch*1e3/1e9, x=dat_t, col="green", type="o", lwd=0.4)

  nr.max = max(c(res_ibm$nrecruits/1e6), dat$recr*1e3/1e6, na.rm=T)
  plot(y=res_ibm$nrecruits/1e6, x=seq(1,nsteps,1), ylab="Recruits (Mn)", xlab="Year", col="cyan3", type="l", ylim=c(0,nr.max))
  points(y=dat$recr*1e3/1e6, x=dat_t, col="green", type="o", lwd=0.4)

  d = pop$get_state()
  d1 = d %>% group_by(age) %>% summarize(mat = length(which(isMature))/length(isMature))
  plot(mat, type="l")
  points(d1$mat~I(d1$age-1), type="o", col="cyan3", xlab = "age") # Decrement age to get the right maturation prob (see note above)
}

```

```{r}
# Create a prototype fish as usual
fish = new(Fish)
fish$par$s0 = 0.07
fish$par$Bhalf = 2.65e8
fish$par$pmrn_lp50 = 118.122779*1.15

sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(1.93e3, 5.61, 10e6)

pop = new(Population, fish)
#pop$par$dsea = 0.09 # tuned value
pop$set_superFishSize(10e6)

nsteps = 500
h = 0.4476934
lf = 45

pop$verbose = F
res_ibm = sim$simulate(pop, lf, h, nsteps, 1.93e3, 5.61, T)

plot_timeseries(res_ibm, pop, h)
```

```{r}
error_fun = function(par, nsup = 10e6, bplot=F){

  fish = new(Fish)
  fish$par$s0 = par[1] #0.07
  fish$par$Bhalf = par[2] #2.65e8
  fish$par$pmrn_lp50 = par[3] #118.122779*1.15
  
  sim = new(Simulator, fish)
  
  sim$equilibriateNaturalPopulation(1.93e3, 5.61, nsup)
  
  pop = new(Population, fish)
  #pop$par$dsea = 0.09 # tuned value
  pop$set_superFishSize(nsup)
  
  nsteps = 500
  h = 0.4476934
  lf = 45
  
  pop$verbose = F
  res_ibm = sim$simulate(pop, lf, h, nsteps, 1.93e3, 5.61, T)
  
  obs = numeric(4)
  obs[1] = mean(dat$ssb*1e3/1e9, na.rm=T)  # MT
  obs[2] = mean(dat$totb*1e3/1e9, na.rm=T) # MT
  obs[3] = mean(dat$catch*1e3/1e9, na.rm=T) # MT
  obs[4] = mean(dat$recr*1e3/1e9, na.rm=T) # recruits in billions
  
  pred = numeric(4)
  pred[1] = mean(res_ibm$ssb[101:500]/1e9, na.rm=T)
  pred[2] = mean(res_ibm$tsb[101:500]/1e9, na.rm=T)
  pred[3] = mean(res_ibm$yield[101:500]/1e9, na.rm=T)
  pred[4] = mean(res_ibm$nrecruits[101:500]/1e9, na.rm=T)
  
  err = sum((obs-pred)^2)

  cat("par = ", par, " | ", err,"\n")
  
  if (bplot) {
    plot_timeseries(res_ibm, pop, h)
    plot(obs~pred)
    abline(0,1,col="grey")
  }
  
  err
}


error_fun(c(0.0815841, 196815664, 148.2958), nsup=2e6, bplot=T)
```

<!-- Optimize -->

<!-- ```{r} -->
<!-- optim(par = c(0.08, 2.65e8, 118), fn = error_fun, ns = 5e6, control=list(parscale=c(0.05, 2.65e8, 118))) -->
<!-- ``` -->

```{r}
error_fun(c(0.08094733, 187837572, 148.6918), ns=5e6, bplot=T)
```


