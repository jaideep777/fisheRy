---
title: "Simulating multiple populations at once"
author: "Jaideep Joshi"
date: "28 March 2022"
output: html_document
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F, echo = F}
library(rfish)
library(tidyverse)
source("../tests/ref/parameters.cod.R")
source("../tests/ref/simulator.7.R")
```

We can use the fishery simulator to simulate multiple populations (i.e., populations with different control parameters) at once. Suppose we want to look at fishery properties as a function of the harvest proportion. 

### Preparation

As usual, we begin with creating a prototype fish 

```{r}
# Create a prototype fish as usual
fish = new(Fish)
# fish$par$s0 = 0.09637

sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(1.93e3, 5.61)
```


### Create a population to simulate

```{r}
pop = new(Population, fish)
# pop$par$Bhalf = 365426284/4.7
pop$set_superFishSize(5e6)
pop$verbose = F
```

This population will be reused by the simulator.

### Simulate

We can now simulate populations with different harvesting rates. Here, we simulate 20 populations with harvesting rates specified by the `hvec` vector. The `simulate_multi` function returns an array if dimensions `{nsteps, length(hvec), 4}`. The last dimension is four because four utilities are returned: {ssb, yield, employment, profit}.

```{r}
nsteps = 200
hvec = seq(0, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)

res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T)
```

### Plot

```{r}
lf = 45
arr = res_ibm_full 
dat_ibm = data.frame(matrix(ncol=4, nrow=0))
colnames(dat_ibm) =c("ssb", "yield", "employment", "profit")
dat = data.frame(matrix(ncol=6, nrow=0))
colnames(dat) =c("ssb", "yield", "emp.sea", "emp.shr", "profit.sea", "profit.shr")
for (ih in 1:length(hvec)){
  res = simulate(hvec[ih], lf, F)
  v = colMeans((res$summaries %>% select(SSB, Y, D.sea, D.shr, P.sea, P.shr))[151:200,])
  dat[nrow(dat)+1,] = v/c(1e9, 1e9, 1, 1, 1e9, 1e9)
  v_ibm = colMeans(arr[151:200, ih, 1,])
  dat_ibm[nrow(dat_ibm)+1,] = v_ibm/c(1e9, 1e9, 1, 1e9)
}
dat$employment = dat$emp.sea+dat$emp.shr
dat$profit = dat$profit.sea+dat$profit.shr


par(mfrow = c(2,2), mar=c(5,5,1,1), cex.lab=1.5, cex.axis=1.5)
matplot(ylab="ssb (MT)",y=cbind(dat_ibm$ssb, dat$ssb, dat_ibm$tsb, dat$tsb), x=hvec, type="l", col=c("cyan2", "black", "orange", "magenta"), lwd=2, lty=1, xlab="Harvest prop")
matplot(ylab="yield (MT)",y=cbind(dat_ibm$yield, dat$yield), x=hvec, type="l", col=c("cyan2", "black"), lwd=2, lty=1, xlab="Harvest prop")
matplot(ylab="employment (PY)",y=cbind(dat_ibm$employment, dat$employment), x=hvec, type="l", col=c("cyan2", "black"), lwd=2, lty=1, xlab="Harvest prop")
matplot(ylab="profit (Bn NOK)",y=cbind(dat_ibm$profit, dat$profit), x=hvec, type="l", col=c("cyan2", "black"), lwd=2, lty=1, xlab="Harvest prop")

```
