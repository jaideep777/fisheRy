---
title: "Simulating multiple populations at once"
author: "Jaideep Joshi"
date: "28 March 2022"
output: html_document
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F, echo = F}
library(fisheRy)
library(tidyverse)
source("../tests/ref/parameters.cod.R")
source("../tests/ref/simulator.7.R")
```

```{r}
re_simulate = F

# if one of the files doesnt exist, re-run the simulations
re_simulate = re_simulate | !file.exists("outputs/res_ibm_scan_T.Rdata")
```

We can use the fishery simulator to simulate multiple populations (i.e., populations with different control parameters) at once. Suppose we want to look at fishery properties as a function of the harvest proportion. 

### Preparation

```{r}
params_file = "../params/cod_params.ini"
```

As usual, we begin with creating a prototype fish 

```{r}
# Create a prototype fish as usual
fish = new(Fish, params_file)

# Create a simulator
sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(params_file, 1.93e3, 5.61, 2e6)
```


### Create a population to simulate

Then we create a population that will be reused by the simulator.

```{r}
pop = new(Population, fish)
pop$readParams(params_file, F)
pop$set_superFishSize(5e6)
pop$verbose = F
```



### Plotting utility

```{r}
source("../R/plot_scan.R")
```

### Simulate

We can now simulate populations with different harvesting rates. Here, we simulate 20 populations with harvesting rates specified by the `hvec` vector. The `simulate_multi` function returns an array if dimensions `{nsteps, length(hvec), 4}`. The last dimension is four because four utilities are returned: {ssb, yield, employment, profit}.

```{r fig.height=9}
nsteps = 200
hvec = seq(0, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)
Tvec = seq(4, 8, length.out = 20)

if(re_simulate){
  res_ibm_full = sim$simulate_multi_2d(pop, Tvec, c(45), c(0.44), nsteps, 1.93e3, T)
  save(res_ibm_full, file="outputs/res_ibm_scan_T.Rdata")
} else{
  load("outputs/res_ibm_scan_T.Rdata")
}

lf = 45
arr = res_ibm_full 
names = pop$colnames
dat_ibm = data.frame(matrix(ncol=length(names), nrow=0))
colnames(dat_ibm) = names
for (i in 1:length(Tvec)){
  v_ibm = colMeans(arr[101:200, 1, 1, i,])
  dat_ibm[nrow(dat_ibm)+1,] = v_ibm
}

plot_scan(dat_ibm, xname = expression("Temperature ("^o*"C)"), xvec = Tvec)
```

### Effect of harvest proportion (bioenergetic model)


Generate reference 

```{r}
dat_ref = data.frame(matrix(ncol=7, nrow=0))
colnames(dat_ref) = c("ssb", "tsb", "yield", "employment.sea", "employment.shore", "profit.sea", "profit.shore")
for (ih in 1:length(hvec)){
  res = simulate(hvec[ih], lf, F)
  v = colMeans((res$summaries %>% select(SSB, TSB, Y, D.sea, D.shr, P.sea, P.shr))[101:200,])
  dat_ref[nrow(dat_ref)+1,] = v
}
```

```{r fig.height=9}
fish = new(Fish, "../params/cod_params.ini")
sim = new(Simulator, fish)
sim$equilibriateNaturalPopulation(params_file, 1.93e3, 5.61, 2e6)

pop = new(Population, fish)
pop$readParams(params_file, F)
# pop$par$dsea = 0.02
pop$set_superFishSize(5e6)
pop$verbose = F

nsteps = 200
hvec = seq(0.01, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)
Tvec = seq(4, 8, length.out = 20)

if(re_simulate){
  res_ibm_full = sim$simulate_multi_2d(pop, c(5.61), c(45), hvec, nsteps, 1.93e3, T)
  save(res_ibm_full, file="outputs/res_ibm_scan_h.Rdata")
} else { 
  load("outputs/res_ibm_scan_h.Rdata")
}

lf = 45
arr = res_ibm_full 
names = pop$colnames
dat_ibm = data.frame(matrix(ncol=length(names), nrow=0))
colnames(dat_ibm) = names
for (i in 1:length(Tvec)){
  v_ibm = colMeans(arr[101:200, i, 1, 1,])
  dat_ibm[nrow(dat_ibm)+1,] = v_ibm
}

plot_scan(dat_ibm, xname = expression("Harvest proportion"), xvec = hvec, dat_ref=dat_ref)
```

### Effect of harvest proportion (Dankel et al. model)

We also look at the predictions of the Dankel et al model implementation, and compare it with their results. 

```{r fig.height=9}
fish = new(Fish, "../params/cod_params_dankel22.ini")

sim = new(Simulator, fish)

sim$equilibriateNaturalPopulation(params_file, 1.93e3, 5.61, 2e6)

pop = new(Population, fish)
pop$readParams(params_file, F)
pop$par$f_harvest_spg = 0
pop$par$recruitmentAge = 1
pop$par$dmax = 30000
pop$set_superFishSize(5e6)
pop$verbose = F

nsteps = 200
hvec = seq(0.01, 0.99, length.out = 20)
lminvec = seq(45, 200, length.out = 3)
Tvec = seq(4, 8, length.out = 20)

if(re_simulate){
  res_ibm_full = sim$simulate_multi_2d(pop, c(5.61), c(45), hvec, nsteps, 1.93e3, T)
  save(res_ibm_full, file="outputs/res_ibm_scan_h_Dankel22.Rdata")
} else {
  load("outputs/res_ibm_scan_h_Dankel22.Rdata")
}

lf = 45
arr = res_ibm_full 
names = pop$colnames
dat_ibm = data.frame(matrix(ncol=length(names), nrow=0))
colnames(dat_ibm) = names
for (i in 1:length(Tvec)){
  v_ibm = colMeans(arr[101:200, i, 1, 1,])
  dat_ibm[nrow(dat_ibm)+1,] = v_ibm
}

plot_scan(dat_ibm, xname = expression("Harvest proportion"), xvec = hvec, dat_ref=dat_ref)
```

<!-- ### Simulate with old mortality model -->

<!-- ```{r} -->
<!-- fish = new(Fish) -->
<!-- fish$par$use_old_model_mor = T -->

<!-- sim = new(Simulator, fish) -->

<!-- sim$equilibriateNaturalPopulation(1.93e3, 5.61, 10e6) -->

<!-- pop = new(Population, fish) -->
<!-- pop$verbose = F -->

<!-- nsteps = 200 -->
<!-- hvec = seq(0, 0.99, length.out = 20) -->
<!-- lminvec = seq(45, 200, length.out = 3) -->

<!-- res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T) -->

<!-- plot_hscan(res_ibm_full) -->
<!-- ``` -->

<!-- ### Simulate with fully old model (new effort dynamics) -->

<!-- ```{r} -->
<!-- fish = new(Fish) -->
<!-- fish$par$growth_model = 0 -->
<!-- fish$par$use_old_model_mor = T -->
<!-- fish$par$use_old_model_mat = T -->
<!-- fish$par$use_old_model_fec = T -->
<!-- fish$par$s0 = 0.0937 -->

<!-- sim = new(Simulator, fish) -->

<!-- sim$equilibriateNaturalPopulation(1.93e3, 5.61, 10e6) -->

<!-- pop = new(Population, fish) -->
<!-- pop$par$Bhalf = 3.65e8 -->
<!-- pop$par$dsea = 0.054 # (original value) -->
<!-- pop$set_superFishSize(2e6) -->
<!-- pop$verbose = F -->

<!-- nsteps = 200 -->
<!-- hvec = seq(0, 0.99, length.out = 20) -->
<!-- lminvec = seq(45, 200, length.out = 3) -->

<!-- res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T) -->

<!-- plot_hscan(res_ibm_full) -->
<!-- ``` -->

<!-- ### Simulate with fully old model (new effort dynamics, tuned dsea) -->

<!-- Notice that with the new effort dynamics model, employment is slightly underpredicted. Therefore, it is necessary to recalibrate the parameter `dsea` as here.  -->

<!-- Besides, since there is a condition that there is at least 1 superfish in the population at all times to prevent a complete population collapse, calculating average mortality over the fishable population as $M=\sum{w_i m_i}/\sum{w_i}$ with $i$ running over all age classes results in a finite (or even increasing) employment at sea at high harvest proportions. To solve this problem, I exclude $i=1$ in the expression for $M$.  -->

<!-- ```{r} -->
<!-- fish = new(Fish) -->
<!-- fish$par$growth_model = 0 -->
<!-- fish$par$use_old_model_mor = T -->
<!-- fish$par$use_old_model_mat = T -->
<!-- fish$par$use_old_model_fec = T -->
<!-- fish$par$s0 = 0.0937 -->

<!-- sim = new(Simulator, fish) -->

<!-- sim$equilibriateNaturalPopulation(1.93e3, 5.61, 10e6) -->

<!-- pop = new(Population, fish) -->
<!-- pop$par$Bhalf = 3.65e8 -->
<!-- pop$par$dsea = 0.09 # tuned value -->
<!-- pop$set_superFishSize(2e6) -->
<!-- pop$verbose = F -->

<!-- nsteps = 200 -->
<!-- hvec = seq(0, 0.99, length.out = 20) -->
<!-- lminvec = seq(45, 200, length.out = 3) -->

<!-- res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T) -->

<!-- plot_hscan(res_ibm_full) -->
<!-- ``` -->

<!-- ### Simulate with old growth model, rest new -->

<!-- ```{r} -->
<!-- fish = new(Fish) -->
<!-- fish$par$growth_model = 0 -->
<!-- fish$par$use_old_model_mor = F -->
<!-- fish$par$use_old_model_mat = F -->
<!-- fish$par$use_old_model_fec = F -->
<!-- fish$par$s0 = 0.09637 -->

<!-- sim = new(Simulator, fish) -->

<!-- sim$equilibriateNaturalPopulation(1.93e3, 5.61, 10e6) -->

<!-- pop = new(Population, fish) -->
<!-- pop$par$Bhalf = 3.65e8 -->
<!-- pop$par$dsea = 0.09 # tuned value -->
<!-- pop$set_superFishSize(2e6) -->
<!-- pop$verbose = F -->

<!-- nsteps = 200 -->
<!-- hvec = seq(0, 0.99, length.out = 20) -->
<!-- lminvec = seq(45, 200, length.out = 3) -->

<!-- res_ibm_full = sim$simulate_multi_2d(pop, c(45), hvec, nsteps, 1.93e3, 5.61, T) -->

<!-- plot_hscan(res_ibm_full) -->
<!-- ``` -->
