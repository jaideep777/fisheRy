---
title: "Simulating a fish population without fishing"
author: "Jaideep Joshi"
date: "28 March 2022"
output:
  html_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F, echo = F}
library(fisheRy)
source("../tests/ref/parameters.cod.R")
source("../tests/ref/simulator.7.R")
```

<!-- ### Create a fish -->

<!-- A population is a collection of fish. Therefore to create a population, we first create a fish. This fish will be used a prototype to construct the population. -->

<!-- Here, we create a fish and set some parameters: -->

```{r}
params_file = "../params/cod_params.ini"
```

<!-- Let us set parameters that allow us to reproduce the Dankel et al XXXX model. -->

<!-- ```{r } -->
<!-- fish = new(Fish, params_file) -->
<!-- fish$par$Bhalf = 3.65e8 -->

<!-- fish$par$growth_model_name = "Dankel22" -->
<!-- fish$par$maturation_model_name = "Dankel22" -->
<!-- fish$par$mortality_model_name = "Dankel22" -->
<!-- fish$par$recruitment_model_name = "BevertonHoltDirect" -->

<!-- fish$init(1.93e3, 5.61) -->
<!-- fish$par$print() -->
<!-- fish$get_state() -->
<!-- ``` -->

<!-- ### Create a population -->

<!-- The constructor for the population requires a Fish object as an argument. This fish object will be used as a prototype to construct all fish in the population. You can create a fish population as follows: -->

<!-- ```{r} -->
<!-- pop = new(Population, fish)   -->
<!-- ``` -->

<!-- ### Setting population parameters -->

<!-- Population parameters can be set in the same way as fish parameters, using the `par` object in the population -->

<!-- Two parameters are important: -->

<!-- -   `n` - Superfish size. Since the population can have billions of fish, we do not simulate each individual fish. Rather, each "Fish" represents a group of `n` actual fish. This collection is called "Superfish". Reducing this parameter will necessitate simulating more agents in the model, which will reduce noise but also take more computational time. -->
<!-- -   `Bhalf` - This is a parameter that controls density dependent recruitment. -->

<!-- ```{r} -->
<!-- pop$par$n = 2e6  # Each superfish contains so many fish -->
<!-- ``` -->

<!-- We can also set the management parameters for a population: -->

<!-- -   Harvest proportion - the proportion of fish that are allowed to be harvested every year -->
<!-- -   Minimum size limit - the size below which fish cannot be harvested -->

<!-- ```{r} -->
<!-- pop$set_harvestProp(0)   # Harvest  -->
<!-- pop$set_minSizeLimit(45) # Only fish above 45 cm length can be harvested -->
<!-- ``` -->

<!-- ### Initialising a population -->

<!-- By default, a population contains no fish. We must initialize the population with specified number of superfish. -->

<!-- ```{r} -->
<!-- pop$init(1000, 1.93e3, 5.61)  # initialize the population with 1000 agents (superfish) -->
<!-- ``` -->

<!-- We can also peek at the state of the population. The state of the population is simply a dataframe consisting of the state of each superfish in the population. -->

<!-- ```{r} -->
<!-- d = pop$get_state() -->
<!-- head(d) -->
<!-- ``` -->

<!-- ### Simulating an unfished population -->

<!-- We can simulate a population by continuously `update`ing it. Each update performs 1 year of simulation, implementing the processes of maturation, growth, mortality, and reproduction for each fish in the population. -->

<!-- For example, let is simulate a population for 200 years. -->

<!-- ```{r fig.height=9} -->
<!-- pop$verbose = T -->
<!-- nsteps = 200             # Let's simulate for 200 years -->
<!-- nfish = numeric(nsteps)  # Let's keep track of the number of superfish -->
<!-- nfish[1]=1000            # Since we initialized the population with 1000 superfish -->
<!-- cnames = pop$colnames -->
<!-- dat = data.frame(matrix(ncol=length(cnames), nrow=0)) -->
<!-- colnames(dat) = cnames -->
<!-- trait_dist = array(dim = c(6, nsteps, 100)) -->
<!-- trait_scalars = c(6.5, 0.09, 150, -6.6, 50, 0.06) -->
<!-- trait_breaks = seq(0,2,length.out=101) -->
<!-- trait_names = c("alpha1", "gsi", "pmrn_intercept", "pmrn_slope", "pmrn_width", "s0") -->
<!-- for (i in 1:nsteps){ -->
<!--   v = pop$update(5.61)       # Update all fish over 1 year  -->
<!--   dat[i,] = v    # some book-keeping -->
<!--   traits = pop$get_traits() -->
<!--   for (it in 1:6){ -->
<!--     h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F) -->
<!--     trait_dist[it,i,] = h$density -->
<!--   } -->
<!--   nfish[i] = pop$nfish() -->
<!-- } -->

<!-- d = pop$get_state() -->
<!-- dist = table(d$age, d$length) -->

<!-- par(mfrow = c(3,1), mar=c(5,5,1,1), oma=c(1,1,1,1), cex.lab=1.5, cex.axis=1.5) -->
<!-- plot(nfish~seq(1,nsteps,1), ylab="No. of superfish", xlab="Year") -->
<!-- image(x=as.numeric(rownames(dist)), y = as.numeric(colnames(dist)), z=log(1+3*log(dist)), col=scales::viridis_pal()(100), xlab="Age", ylab="Length") -->

<!-- res = simulate(0, 45, F) -->
<!-- matplot(cbind(dat$ssb/1e9, res$summaries$SSB[1:nsteps]/1e9), ylab="SSB (MT)", xlab="Year", col=c("cyan", "black"), lty=1, type=c("p","l"), pch=1) -->

<!-- par(mfrow = c(3,2), mar=c(4,4,1,1), oma=c(1,1,1,1), cex.lab=1.3, cex.axis=1.2) -->
<!-- for (it in 1:6){ -->
<!--   image(y=(trait_breaks[-1]-diff(trait_breaks)/2)*abs(trait_scalars[it]), x=1:nsteps, z=log(1e-4+trait_dist[it,,]), col=scales::viridis_pal()(100), xlab="Time", ylab=trait_names[it])  -->
<!-- } -->
<!-- ``` -->

<!-- ### Bioenergetic model -->

# Status quo conditions

Now, let's simulate the bioenergetic model with evolution.

```{r fig.height=9}

fish = new(Fish, params_file)
fish$trait_variances = c(1, 1, 1, 1, 1, 0)*0.01

pop = new(Population, fish)  
pop$par$n = 4e6  # Each superfish contains so many fish
pop$par$f_harvest_spg = 0.23
pop$par$simulate_bio_only = T
pop$set_harvestProp(0)
pop$init(1000, 1.93e3, 5.61)  # initialize the population with 1000 agents (superfish)

pop$verbose = T
nsteps = 1000             # Let's simulate for 200 years
nfish = numeric(nsteps)  # Let's keep track of the number of superfish
nfish[1]=1000            # Since we initialized the population with 1000 superfish

temp = rep(5.61, nsteps)
temp[(nsteps/2+1):nsteps] = seq(5.61,10, length.out=nsteps/2)

cnames = pop$colnames
dat = data.frame(matrix(ncol=length(cnames), nrow=0))
colnames(dat) = cnames
trait_dist = array(dim = c(6, nsteps, 100))
trait_scalars = c(6.5, 0.09, 150, -6.6, 50, 0.06)
trait_breaks = seq(0,2.5,length.out=101)
trait_names = c("alpha1", "gsi", "pmrn_intercept", "pmrn_slope", "pmrn_width", "s0")
trait_means = array(dim=c(6, nsteps))

for (i in 1:100){
  v = pop$update(5.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}

pop$set_harvestProp(0.5)

for (i in 1:(nsteps/2)){
  v = pop$update(5.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}


for (i in (nsteps/2+1):nsteps){
  v = pop$update(5.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}


d = pop$get_state()
dist = table(d$age, d$length)

par(mfrow = c(3,1), mar=c(5,5,1,1), oma=c(1,1,1,1), cex.lab=1.5, cex.axis=1.5)
plot(nfish~seq(1,nsteps,1), ylab="No. of superfish", xlab="Year")
image(x=as.numeric(rownames(dist)), y = as.numeric(colnames(dist)), z=log(1+3*log(dist)), col=scales::viridis_pal()(100), xlab="Age", ylab="Length")

res = simulate(0, 45, F)
matplot(cbind(dat$ssb/1e9), ylab="SSB (MT)", xlab="Year", col=c("cyan4", "black"), lty=1, type=c("p","l"), pch=1)


par(mfrow = c(3,2), mar=c(4,4,1,1), oma=c(1,1,1,1), cex.lab=1.3, cex.axis=1.2)
for (it in 1:6){
  image(y=(trait_breaks[-1]-diff(trait_breaks)/2)*abs(trait_scalars[it]), x=1:nsteps, z=log(1e-4+trait_dist[it,,]), col=scales::viridis_pal()(100), xlab="Time", ylab=trait_names[it]) 
  lines(y=trait_means[it,], x=1:nsteps, col="white", lwd=2)
}
```



# Status quo followed by elevated temperature (2 deg)

Now, let's simulate the bioenergetic model with evolution.

```{r fig.height=9}

fish = new(Fish, params_file)
fish$trait_variances = c(1, 1, 1, 1, 1, 0)*0.01

pop = new(Population, fish)  
pop$par$n = 4e6  # Each superfish contains so many fish
pop$par$f_harvest_spg = 0.23
pop$par$simulate_bio_only = T
pop$set_harvestProp(0)
pop$init(1000, 1.93e3, 5.61)  # initialize the population with 1000 agents (superfish)

pop$verbose = T
nsteps = 1000             # Let's simulate for 200 years
nfish = numeric(nsteps)  # Let's keep track of the number of superfish
nfish[1]=1000            # Since we initialized the population with 1000 superfish

temp = rep(5.61, nsteps)
temp[(nsteps/2+1):nsteps] = seq(5.61,10, length.out=nsteps/2)

cnames = pop$colnames
dat = data.frame(matrix(ncol=length(cnames), nrow=0))
colnames(dat) = cnames
trait_dist = array(dim = c(6, nsteps, 100))
trait_scalars = c(6.5, 0.09, 150, -6.6, 50, 0.06)
trait_breaks = seq(0,2.5,length.out=101)
trait_names = c("alpha1", "gsi", "pmrn_intercept", "pmrn_slope", "pmrn_width", "s0")
trait_means = array(dim=c(6, nsteps))

for (i in 1:100){
  v = pop$update(5.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}

pop$set_harvestProp(0.5)

for (i in 1:(nsteps/2)){
  v = pop$update(5.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}


for (i in (nsteps/2+1):nsteps){
  v = pop$update(7.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}


d = pop$get_state()
dist = table(d$age, d$length)

par(mfrow = c(3,1), mar=c(5,5,1,1), oma=c(1,1,1,1), cex.lab=1.5, cex.axis=1.5)
plot(nfish~seq(1,nsteps,1), ylab="No. of superfish", xlab="Year")
image(x=as.numeric(rownames(dist)), y = as.numeric(colnames(dist)), z=log(1+3*log(dist)), col=scales::viridis_pal()(100), xlab="Age", ylab="Length")

res = simulate(0, 45, F)
matplot(cbind(dat$ssb/1e9), ylab="SSB (MT)", xlab="Year", col=c("cyan4", "black"), lty=1, type=c("p","l"), pch=1)


par(mfrow = c(3,2), mar=c(4,4,1,1), oma=c(1,1,1,1), cex.lab=1.3, cex.axis=1.2)
for (it in 1:6){
  image(y=(trait_breaks[-1]-diff(trait_breaks)/2)*abs(trait_scalars[it]), x=1:nsteps, z=log(1e-4+trait_dist[it,,]), col=scales::viridis_pal()(100), xlab="Time", ylab=trait_names[it]) 
  lines(y=trait_means[it,], x=1:nsteps, col="white", lwd=2)
}
```



# Status quo followed by reduced harvest rate (0.5 --> 0.4)

Now, let's simulate the bioenergetic model with evolution.

```{r fig.height=9}

fish = new(Fish, params_file)
fish$trait_variances = c(1, 1, 1, 1, 1, 0)*0.01

pop = new(Population, fish)  
pop$par$n = 4e6  # Each superfish contains so many fish
pop$par$f_harvest_spg = 0.23
pop$par$simulate_bio_only = T
pop$set_harvestProp(0)
pop$init(1000, 1.93e3, 5.61)  # initialize the population with 1000 agents (superfish)

pop$verbose = T
nsteps = 1000             # Let's simulate for 200 years
nfish = numeric(nsteps)  # Let's keep track of the number of superfish
nfish[1]=1000            # Since we initialized the population with 1000 superfish

temp = rep(5.61, nsteps)
temp[(nsteps/2+1):nsteps] = seq(5.61,10, length.out=nsteps/2)

cnames = pop$colnames
dat = data.frame(matrix(ncol=length(cnames), nrow=0))
colnames(dat) = cnames
trait_dist = array(dim = c(6, nsteps, 100))
trait_scalars = c(6.5, 0.09, 150, -6.6, 50, 0.06)
trait_breaks = seq(0,2.5,length.out=101)
trait_names = c("alpha1", "gsi", "pmrn_intercept", "pmrn_slope", "pmrn_width", "s0")
trait_means = array(dim=c(6, nsteps))

for (i in 1:100){
  v = pop$update(5.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}

pop$set_harvestProp(0.5)

for (i in 1:(nsteps/2)){
  v = pop$update(5.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}

pop$set_harvestProp(0.4)

for (i in (nsteps/2+1):nsteps){
  v = pop$update(5.61) #temp[i])       # Update all fish over 1 year 
  dat[i,] = v    # some book-keeping
  traits = pop$get_traits()
  traits = pop$get_traits()
  for (it in 1:6){
    h = hist(traits[,it]/trait_scalars[it], breaks = trait_breaks, plot=F)
    trait_dist[it,i,] = h$density
    trait_means[it,i] = abs(mean(traits[,it]))
  }
  nfish[i] = pop$nfish()
}


d = pop$get_state()
dist = table(d$age, d$length)

par(mfrow = c(3,1), mar=c(5,5,1,1), oma=c(1,1,1,1), cex.lab=1.5, cex.axis=1.5)
plot(nfish~seq(1,nsteps,1), ylab="No. of superfish", xlab="Year")
image(x=as.numeric(rownames(dist)), y = as.numeric(colnames(dist)), z=log(1+3*log(dist)), col=scales::viridis_pal()(100), xlab="Age", ylab="Length")

res = simulate(0, 45, F)
matplot(cbind(dat$ssb/1e9), ylab="SSB (MT)", xlab="Year", col=c("cyan4", "black"), lty=1, type=c("p","l"), pch=1)


par(mfrow = c(3,2), mar=c(4,4,1,1), oma=c(1,1,1,1), cex.lab=1.3, cex.axis=1.2)
for (it in 1:6){
  image(y=(trait_breaks[-1]-diff(trait_breaks)/2)*abs(trait_scalars[it]), x=1:nsteps, z=log(1e-4+trait_dist[it,,]), col=scales::viridis_pal()(100), xlab="Time", ylab=trait_names[it]) 
  lines(y=trait_means[it,], x=1:nsteps, col="white", lwd=2)
}
```




<!-- ### Quickly simulating an unfished population to equilibrium -->

<!-- It is possible to manually simulate a non-fished population to equilibrium as demonstrated in the previous tutorial. But there's an easier way: to quickly simulate an unfished population, we can use the function `noFishingEquilibriate()`. -->

<!-- ```{r} -->

<!-- # Create a population -->

<!-- pop_K = new(Population, fish) -->

<!-- pop_K$set_superFishSize(20e6) -->

<!-- # Equilibriate under no-fishing conditions -->

<!-- pop_K$verbose = T -->

<!-- state_equil = pop_K$noFishingEquilibriate(1.93e3, 5.61) -->

<!-- d = pop_K$get_state() -->

<!-- dist = table(d$age, d$length) -->

<!-- image(x=as.numeric(rownames(dist)), y = as.numeric(colnames(dist)), z=log(1+3*log(dist)), col=scales::viridis_pal()(100), xlab="Age", ylab="Length") -->

<!-- ``` -->
