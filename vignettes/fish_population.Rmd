---
title: "Simulating a fish population without fishing"
author: "Jaideep Joshi"
date: "28 March 2022"
output: html_document
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F, echo = F}
library(rfish)
source("../tests/ref/parameters.cod.R")
source("../tests/ref/simulator.7.R")
```

### Create a fish

A population is a collection of fish. Therefore to create a population, we first create a fish. This fish will be used a prototype to construct the population.

Here, we create a fish and set some parameters:

```{r }
fish = new(Fish)
fish$par$flag = 1
# fish$par$s0 = 0.0445
fish$par$growth_model = 1
fish$par$use_old_model_mat = F
fish$par$use_old_model_mor = F
fish$par$use_old_model_fec = F
# fish$par$beta1 = 0
# fish$par$beta2 = 0

# fish$init(1.93e3, 5.61)
fish$get_state()
```

### Create a population

The constructor for the population requires a Fish object as an argument. You can create a fish population as follows:

```{r}
pop = new(Population, fish)  # This fish object will be used as a prototype to construct all fish in the population
```

### Setting population parameters

Population parameters can be set in the same way as fish parameters, using the `par` object in the population

Two parameters are important:
+ `n` - Superfish size. Since the population can have billions of fish, we do not simulate each individual fish. Rather, each "Fish" represents a group of `n` actual fish. This collection is called "Superfish". Reducing this parameter will necessitate simulating more agents in the model, which will reduce noise but also take more computational time. 
+ `Bhalf` - This is a parameter that controls density dependent recruitment. 


```{r}
pop$par$n = 20e6  # Each superfish contains 500,000 fish
pop$par$Bhalf = 3.65e9
```

We can also set the management parameters for a population:

+ Harvest proportion - the proportion of fish that are allowed to be harvested every year
+ Minimum size limit - the size below which fish cannot be harvested

```{r}
pop$set_harvestProp(0)   # Harvest 
pop$set_minSizeLimit(45) # Only fish above 45 cm length can be harvested
```

### Initialising a population

By default, a population contains no fish. We must initialize the population with specified number of superfish.

```{r}
pop$init(1000, 1.93e3, 5.61)  # initialize the population with 1000 agents (superfish)
```

We can also peek at the state of the population. The state of the population is simply a dataframe consisting of the state of each superfish in the population.

```{r}
d = pop$get_state()
head(d)
```

### Simulating an unfished population

We can simulate a population by continuously `update`ing it. Each update performs 1 year of simulation, implementing the processes of maturation, growth, mortality, and reproduction for each fish in the population.

For example, let is simulate a population for 200 years.

```{r fig.height=9}
pop$verbose = T
nsteps = 200             # Let's simulate for 200 years
nfish = numeric(nsteps)  # Let's keep track of the number of superfish
nfish[1]=1000            # Since we initialized the population with 1000 superfish
dat = data.frame(ssb=0, yield=0, emp_sea=0, emp_shore=0, profit_sea=0, profit_shr=0, tsb=0)
for (i in 2:nsteps){
  v = pop$update(5.61)       # Update all fish over 1 year 
  dat = rbind(dat, v)    # some book-keeping
  nfish[i] = pop$nfish()
}
dat = dat[-1,]

d = pop$get_state()
dist = table(d$age, d$length)

par(mfrow = c(3,1), mar=c(5,5,1,1), oma=c(1,1,1,1), cex.lab=1.5, cex.axis=1.5)
plot(nfish~seq(1,nsteps,1), ylab="No. of superfish", xlab="Year")
image(x=as.numeric(rownames(dist)), y = as.numeric(colnames(dist)), z=log(1+3*log(dist)), col=scales::viridis_pal()(100), xlab="Age", ylab="Length")

res = simulate(0, 45, F)
matplot(cbind(dat$ssb/1e9, res$summaries$SSB[1:199]/1e9), ylab="SSB (MT)", xlab="Year", col=c("cyan", "black"), lty=1, type=c("p","l"), pch=1)

```


### Quickly simulating an unfished population to equilibrium

It is possible to manually simulate a non-fished population to equilibrium as demonstrated in the previous tutorial. But there's an easier way: to quickly simulate an unfished population, we can use the function `noFishingEquilibriate()`.

```{r}
# Create a prototype fish as usual
fish = new(Fish)
# fish$par$s0 = 0.09637

# Create a population
pop_K = new(Population, fish)
pop_K$set_superFishSize(20e6)

# Equilibriate under no-fishing conditions
K_ibm = pop_K$noFishingEquilibriate(1.93e3, 5.61)
```



