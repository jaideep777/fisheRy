---
title: "Creating and simulating a single fish"
author: "Jaideep Joshi"
date: "28 March 2022"
output: html_document
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
```

```{r, include = F, echo = F}
library(tidyverse)
library(rfish)
```

## Simulating a fish

### Creating a fish object

A fish can be created by instancing an object of the Rcpp class `Fish`. Fish parameters should be specified by passing a parameters file to the constructor. 

The format of the parameters file is `.ini`, which can be a simple text file containing key-value pairs, such as 
```{r}
# Parmaeters for NEA cod
beta = 0.655793 # 0.648728
r = 0.090367 # 0.077281
c = 6.519584 # 6.318308 #6.51559
```
where text followed by `#` are comments as in R.


```{r }
params_file = "../params/cod_params.ini"
fish = new(Fish, params_file)
```

After instantiation, the fish must be initialized using the `init()` function, which computes dependent parameter values and sets the initial length of the fish. The function `init()` needs 2 arguments, the current total stock biomass (in kilotons) and current temperature (in deg C).

```{r}
fish$init(tsb = 1.93e3, temp = 5.61)
fish$t_birth
fish$length
fish$par$print()
```

### Change fish parameters

Some fish parameters can be changed manually after instanciation of the fish object using the `par` object in the fish. 

<span style="color: red;">
After manually changing parameters, the fish must be reinitialized using the same init() function as above.
</span>


```{r}
fish$par$c = 6.5

fish$par$c

fish$init(1.93e3, 5.61)
fish$t_birth
fish$length # Notice the change in initial length due to a change in the parameter 'c'
```

Another way to change fish parameters is to create a parameters object, change the parameters as desired, and assign it to the fish. 

```{r}
# Create parameters object
fish.par = new(FishParams)
fish.par$initFromFile(params_file)

# Change specific parameter values
fish.par$s0 = 0.09637

# Assign it to the fish
fish$par = fish.par

fish$par$s0
fish$init(1.93e3, 5.61)
```


### Get the state of the fish

To get the state of the fish, i.e., its length, age, maturation status, whether it is alive, etc, use the `get_state()` function. The function returns a vector in the following order

+ Year of birth	
+ Age
+ is it mature (T/F)
+ is it alive (T/F)
+ length
+ weight

```{r}
fish$get_state()
```

### Simulate the fish

We can now update the status of the fish by calling its demographic functions. 

To update the maturity of the fish, grow it in length over one year, and increment its age by 1 year, we can do
```{r}
fish$updateMaturity()
fish$grow(0, 5.61)  # The arguments are: total stock biomass and temperature
fish$set_age(fish$age+1) # The argument is the new age

fish$length
```


### Using different models for life processes

Each fish has four life processes:

+ Growth (gro)
+ Maturation (mat)
+ Mortality (mor)
+ Fecundity (fec)

Each of these processes can be simulated either with the model of Dankel et al XXX (old model) or XXX et al XXX (new model). 

To set which model to use, you can set the following four flags to true or false.

```{r}
fish.par$growth_model = 0
fish.par$use_old_model_mat = T
fish.par$use_old_model_mor = T
fish.par$use_old_model_fec = T
```

Here is the growth trajectory of the fish using the model in Dankel et al XXX.

```{r}
fish = new(Fish)
fish$par$growth_model = 0
fish$init(1.93e3, 5.61)


dat = data.frame(t_birth=0,	age=0,	isMature=0,	isAlive=0,	length=0,	weight=0)
dat = rbind(dat, fish$get_state())
dat = dat[-1,]
for (i in 1:30){
  dat = rbind(dat, fish$get_state())
  fish$updateMaturity()
  fish$grow(1.93e3, 5.61)
  fish$set_age(fish$age+1)
}
plot(dat$length~dat$age, type="l", xlab="Age", ylab="Length", col="black")
```



<!-- ### Beverton Holt Recruitment -->

<!-- ```{r} -->
<!-- x = seq(0,10, length.out=100) -->
<!-- y = 1/(1+x/0.17) -->
<!-- plot(y~x, type="l", col="cyan3", xlab="Spawning stock biomass (Mt)", ylab = "Fraction of maximum recruits") -->
<!-- ``` -->



<!-- ### Compare growth and mortality based on old and new models -->

<!-- ```{r} -->

<!-- plot(x=1, y=NA, xlim=c(0,31), ylim=c(0,200), xlab="age", ylab = "length") -->

<!-- # NEW MODEL -->
<!-- mat_ages = numeric(0) -->
<!-- mort = data.frame(a=0, m=0, l=0) -->
<!-- N = 100 -->
<!-- for (f in 1:N){ -->
<!--   #cat("f = ", f, "\n") -->
<!--   fish.par = new(FishParams) -->
<!--   fish.par$s0 = 0.09637 -->
<!--   # fish.par$Bhalf_growth = 1e11 -->

<!--   fish = new(Fish) -->
<!--   fish.par$flag = 1 -->
<!--   fish.par$growth_model = 1 -->
<!--   fish$par = fish.par -->
<!--   fish$init(1.93e3, 5.61) -->

<!--   dat = data.frame(t_birth=0,	age=0,	isMature=0,	isAlive=0,	length=0,	weight=0) -->
<!--   dat = rbind(dat, fish$get_state()) -->
<!--   dat = dat[-1,] -->
<!--   for (i in 1:30){ -->
<!--     #cat("rmat prob: age = ", fish$age, ", p = ", 1 / (1 + exp( -(fish$length - (1.604122 * fish$age + 18.399575)) / 1.93031)), "\n") -->
<!--     #cat("f = ", f, "\n") -->
<!--     dat = rbind(dat, fish$get_state()) -->
<!--     mort = rbind(mort, c(a=fish$age,  fish$naturalMortalityRate(), fish$length)) -->
<!--     fish$updateMaturity() -->
<!--     fish$grow(1.93e3, 5.61) -->
<!--     fish$set_age(fish$age+1) -->
<!--   } -->
<!--   mat_ages = c(mat_ages, which(dat$isMature>0)[1]) -->
<!--   points(dat$length~dat$age, type="l", col=rainbow(N)[f]) -->
<!-- } -->
<!-- table(mat_ages) -->

<!-- # OLD MODEL -->
<!-- N=1 -->
<!-- for (f in 1:N){ -->
<!--   #cat("f = ", f, "\n") -->
<!--   fish.par = new(FishParams) -->
<!--   fish.par$s0 = 0.09637 -->
<!--   # fish.par$Bhalf_growth = 1e11 -->

<!--   fish = new(Fish) -->
<!--   fish.par$flag = 1 -->
<!--   fish.par$growth_model = 0 -->
<!--   fish$par = fish.par -->
<!--   fish$init(1.93e3, 5.61) -->

<!--   dat = data.frame(t_birth=0,	age=0,	isMature=0,	isAlive=0,	length=0,	weight=0) -->
<!--   dat = rbind(dat, fish$get_state()) -->
<!--   dat = dat[-1,] -->
<!--   for (i in 1:30){ -->
<!--     #cat("rmat prob: age = ", fish$age, ", p = ", 1 / (1 + exp( -(fish$length - (1.604122 * fish$age + 18.399575)) / 1.93031)), "\n") -->
<!--     #cat("f = ", f, "\n") -->
<!--     dat = rbind(dat, fish$get_state()) -->
<!--     mort = rbind(mort, c(a=fish$age,  fish$naturalMortalityRate(), fish$length)) -->
<!--     fish$updateMaturity() -->
<!--     fish$grow(1.93e3, 5.61) -->
<!--     fish$set_age(fish$age+1) -->
<!--   } -->
<!--   mat_ages = c(mat_ages, which(dat$isMature>0)[1]) -->
<!--   points(dat$length~dat$age, type="l", lwd=2, col="black") -->
<!-- } -->
<!-- ``` -->

<!-- ### Maturation -->



<!-- ### Mortality -->

<!-- ```{r} -->
<!-- source("../tests/ref/parameters.cod.R") -->
<!-- M<-c(M,rep(M[length(M)],times=ages-length(M))); names(M)<-1:ages -->
<!-- with(mort %>% filter(a<=20 & a>1), plot(m~a, ylim=c(0,1), xlab="Age", ylab="Mortality rate")) -->
<!-- points(M, type="l", col="blue") -->

<!-- length_age = mort %>% group_by(a) %>% summarize(l = mean(l)) -->

<!-- ``` -->

