---
title: "Exploring the effect of parameters on unfished population"
author: "Jaideep Joshi"
date: "30 May 2022"
output: html_document
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = F, echo = F}
library(rfish)
source("../tests/ref/parameters.cod.R")
source("../tests/ref/simulator.7.R")
```

### Create a handy function for the simulation

```{r}
explore = function(beta1, beta2, s0, Bhalf, gm = 1, oldmat=F, oldmor=F, oldfec=F, superfish=1e6){
  # Create a prototype fish as usual
  fish = new(Fish)
  fish$par$s0 = s0 # 0.09637
  fish$par$growth_model = gm
  fish$par$use_old_model_mat = oldmat
  fish$par$use_old_model_mor = oldmor
  fish$par$use_old_model_fec = oldfec
  fish$par$beta1 = beta1
  fish$par$beta2 = beta2
  
  pop = new(Population, fish)
  pop$par$Bhalf = Bhalf # 3.65e8 / 4.7
  pop$set_superFishSize(superfish)
  
  nsteps = 200
  sim = new(Simulator, fish)
  sim$equilibriateNaturalPopulation(1.93e3, 5.61, 10e6)
  dat = sim$simulate(pop, 45, 0, nsteps, 1.93e3, 5.61, T)

  d = pop$get_state()
  dist = table(d$age, d$length)
  
  par(mfrow = c(2,2), mar=c(5,5,1,1), oma=c(1,1,1,1), cex.lab=1.5, cex.axis=1.5)
  plot(dat$nsuperfish~seq(1,nsteps,1), ylab="No. of superfish", xlab="Year")
  plot(dat$r0~seq(1,nsteps,1), ylab="Average r0", xlab="Year", ylim = c(0,max(c(dat$r0[!is.nan(dat$r0)], 50))) )
  abline(h = 21.77, col="blue")
  image(x=as.numeric(rownames(dist)), y = as.numeric(colnames(dist)), z=log(1+3*log(dist)), col=scales::viridis_pal()(100), xlab="Age", ylab="Length")
  
  res = simulate(0, 45, F)
  matplot(cbind(dat$ssb/1e9, res$summaries$SSB[1:199]/1e9), ylab="SSB (MT)", xlab="Year", col=c("cyan", "black"), lty=1, type=c("p","l"), pch=1)

}
```

### Reproducing Dankel et al model

```{r}
explore(beta1 = 0, beta2=0, s0 = 0.09637, Bhalf = 3.65e8, gm = 0, oldmat = T, oldmor = T, oldfec = T)
```

### New fecundity model

```{r}
explore(beta1 = 0, beta2=0, s0 = 0.09637, Bhalf = 3.65e8, gm = 0, oldmat = T, oldmor = T, oldfec = F)
```

### New fecundity + new mortality model

```{r}
explore(beta1 = 0, beta2=0, s0 = 0.09637, Bhalf = 3.65e8, gm = 0, oldmat = T, oldmor = F, oldfec = F)
```

### New fecundity + new mortality + new maturity model

```{r}
explore(beta1 = 0, beta2=0, s0 = 0.09637, Bhalf = 3.65e8, gm = 0, oldmat = F, oldmor = T, oldfec = F)
```

### New fecundity + new mortality + new maturity + new growth model

```{r}
explore(beta1 = 0, beta2=0, s0 = 0.09637, Bhalf = 3.65e8, gm = 1, oldmat = T, oldmor = T, oldfec = F)
```

### New fecundity + new mortality + new maturity + new growth model (try reduced Bhalf)

```{r}
explore(beta1 = 0, beta2=0, s0 = 0.09637, Bhalf = 3.65e8 / 4.7, gm = 1, oldmat = F, oldmor = F, oldfec = F)
```


### Add density dependence in growth model (default parameters)

```{r}
explore(beta1 = -7.07e-5, beta2 = 0.178, s0 = 0.09637, Bhalf = 3.65e8, gm = 1, oldmat = T, oldmor = T, oldfec = F, superfish = 5e6)
```

### Add density dependence in growth model (tuned parameters, old mort, old mat)

```{r}
explore(beta1 = -7.07e-5, beta2 = 0.178, s0 = 0.02, Bhalf = 3.65e9, gm = 1, oldmat = T, oldmor = T, oldfec = F, superfish = 20e6)
```

### Add density dependence in growth model (tuned parameters, old mort)

```{r}
explore(beta1 = -7.07e-5, beta2 = 0.178, s0 = 0.02, Bhalf = 3.65e9, gm = 1, oldmat = F, oldmor = T, oldfec = F, superfish = 20e6)
```


### Add density dependence in growth model (tuned parameters)

Irrespective of tuning parameters, it seems to be impossible to get the correct unfished equilibrium SSB with the new mortality model. Therefore sticking to the old one. 


```{r}
explore(beta1 = -7.07e-5, beta2 = 0.178, s0 = 0.025, Bhalf = 7e12, gm = 1, oldmat = F, oldmor = F, oldfec = F, superfish = 50e6)
```